<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Y Block – 3D Viewport</title>
  <style>
    body { margin:0; overflow:hidden; font-family: Arial, sans-serif; background:#000; }
    #instructions {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; background: rgba(0,0,0,0.7); padding: 20px 40px; border-radius: 12px;
      text-align: center; cursor: pointer; user-select: none; z-index: 100;
    }
    #instructions.hidden { display: none; }
    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
      transform: translate(-50%, -50%); pointer-events: none; color: #0f0;
      font-size: 24px; line-height: 20px; text-align: center; z-index: 50; display: none;
    }
    #paste-button {
      position: absolute; top: 20px; right: 20px; z-index: 110;
      padding: 12px 24px; background: #007bff; color: white; border: none;
      border-radius: 6px; cursor: pointer; font-size: 16px;
    }
    #paste-button:hover { background: #0056b3; }
    #paste-modal {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95); padding: 25px; border-radius: 10px;
      width: 420px; max-width: 90%; z-index: 120; display: none; text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    #paste-textarea { width: 100%; height: 220px; margin: 15px 0; font-family: monospace; }
    #submit-paste, #close-modal { padding: 10px 20px; margin: 8px; cursor: pointer; font-size: 14px; }
  </style>
</head>
<body>

<div id="instructions">
  Click anywhere on screen to enter 3D mode<br>
  <small>WASD = move • Q/E = down/up • Mouse = look around • ESC = release mouse</small>
  <br><br><small>(You can paste data below without entering 3D mode)</small>
</div>
<div id="crosshair">+</div>
<button id="paste-button">Paste Excel Data</button>

<div id="paste-modal">
  <h3>Paste Excel Data (Tab-separated from Excel)</h3>
  <p>Expected columns: Container number, Voyage, Discharge port, Location (e.g. Y 39G 2), Group (20 or 40)</p>
  <textarea id="paste-textarea" placeholder="Paste copied rows here..."></textarea>
  <div>
    <button id="submit-paste">Submit & Place Containers</button>
    <button id="close-modal">Close</button>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<script type="module">
  import * as THREE from 'three';
  import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
  import { FontLoader } from 'three/addons/loaders/FontLoader.js';
  import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

  // ─── Scene setup ───────────────────────────────────────────────
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x88aaff);
  scene.fog = new THREE.FogExp2(0x88aaff, 0.0008);

  const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 3000);
  camera.position.set(80, 10, 35); // adjusted for better overview

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  // ─── Controls ──────────────────────────────────────────────────
  const controls = new PointerLockControls(camera, document.body);

  const instructions = document.getElementById('instructions');
  instructions.addEventListener('click', () => controls.lock());

  controls.addEventListener('lock',   () => {
    instructions.classList.add('hidden');
    document.getElementById('crosshair').style.display = 'block';
  });
  controls.addEventListener('unlock', () => {
    instructions.classList.remove('hidden');
    document.getElementById('crosshair').style.display = 'none';
  });

  // Movement
  const move = { forward: false, backward: false, left: false, right: false, up: false, down: false };
  const velocity = new THREE.Vector3();
  const direction = new THREE.Vector3();
  let prevTime = performance.now();

  document.addEventListener('keydown', e => {
    switch (e.code) {
      case 'KeyW': case 'ArrowUp':    move.forward  = true; break;
      case 'KeyS': case 'ArrowDown':  move.backward = true; break;
      case 'KeyA': case 'ArrowLeft':  move.left     = true; break;
      case 'KeyD': case 'ArrowRight': move.right    = true; break;
      case 'KeyE': move.up   = true; break;
      case 'KeyQ': move.down = true; break;
    }
  });

  document.addEventListener('keyup', e => {
    switch (e.code) {
      case 'KeyW': case 'ArrowUp':    move.forward  = false; break;
      case 'KeyS': case 'ArrowDown':  move.backward = false; break;
      case 'KeyA': case 'ArrowLeft':  move.left     = false; break;
      case 'KeyD': case 'ArrowRight': move.right    = false; break;
      case 'KeyE': move.up   = false; break;
      case 'KeyQ': move.down = false; break;
    }
  });

  // ─── Ground (only odd columns: 9,11,...,39 → 16 cells wide) ────
  const oddCols = [];
  for (let n = 9; n <= 39; n += 2) oddCols.push(n);
  const numOddCols = oddCols.length; // 16
  const rows = 7; // A to G
  const cellWidth = 40; // X – numbers/columns
  const cellDepth = 10; // Z – letters/rows
  const gridSizeX = numOddCols * cellWidth;
  const gridSizeZ = rows * cellDepth;

  // Solid plane
  const planeGeo = new THREE.PlaneGeometry(gridSizeX, gridSizeZ);
  const planeMat = new THREE.MeshBasicMaterial({ color: 0x555577, side: THREE.DoubleSide });
  const plane = new THREE.Mesh(planeGeo, planeMat);
  plane.rotation.x = -Math.PI / 2;
  plane.position.y = -0.01;
  scene.add(plane);

  // Grid lines
  const grid = new THREE.GridHelper(gridSizeX, numOddCols, 0x444466, 0xaaccff);
  grid.material.linewidth = 2;
  grid.position.y = 0;
  scene.add(grid);

  // ─── Labels ────────────────────────────────────────────────────
  const loader = new FontLoader();
  loader.load('https://cdn.jsdelivr.net/npm/three@0.170.0/examples/fonts/helvetiker_regular.typeface.json', font => {
    const textMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

    // Numbers: only odd, centered over cells
    oddCols.forEach((num, index) => {
      const textGeo = new TextGeometry(num.toString(), { font, size: 6, depth: 0.5, curveSegments: 4 });
      const mesh = new THREE.Mesh(textGeo, textMat);
      const cellCenterX = -gridSizeX / 2 + (index + 0.5) * cellWidth;
      mesh.position.set(cellCenterX, 0.2, -gridSizeZ / 2 - 25); // further back
      mesh.rotation.x = -Math.PI / 2;
      scene.add(mesh);
    });

    // Letters A–G: centered over rows
    const letters = 'ABCDEFG'.split('');
    for (let i = 0; i < rows; i++) {
      const textGeo = new TextGeometry(letters[i], { font, size: 8, depth: 0.6, curveSegments: 4 });
      const mesh = new THREE.Mesh(textGeo, textMat);
      const cellCenterZ = -gridSizeZ / 2 + (i + 0.5) * cellDepth;
      mesh.position.set(-gridSizeX / 2 - 40, 0.2, cellCenterZ); // further left
      mesh.rotation.x = -Math.PI / 2;
      scene.add(mesh);
    }

    // Title
    const titleGeo = new TextGeometry("Y BLOCK", { font, size: 18, depth: 1.8, curveSegments: 6 });
    const title = new THREE.Mesh(titleGeo, new THREE.MeshBasicMaterial({ color: 0xffff88 }));
    title.position.set(0, 30, -gridSizeZ / 2 - 70);
    title.rotation.x = -Math.PI / 2;
    scene.add(title);
  });

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 1.2));
  const sun = new THREE.DirectionalLight(0xffffe0, 1.5);
  sun.position.set(200, 400, 150);
  scene.add(sun);

  // Containers tracking
  const containers = new Map();

  // Paste modal
  const pasteButton = document.getElementById('paste-button');
  const pasteModal = document.getElementById('paste-modal');
  const pasteTextarea = document.getElementById('paste-textarea');
  const submitPaste = document.getElementById('submit-paste');
  const closeModal = document.getElementById('close-modal');

  pasteButton.addEventListener('click', () => pasteModal.style.display = 'block');
  closeModal.addEventListener('click', () => pasteModal.style.display = 'none');

  submitPaste.addEventListener('click', () => {
    const data = pasteTextarea.value.trim();
    if (!data) return;

    const lines = data.split('\n').map(l => l.trim()).filter(l => l);
    let start = 0;
    if (lines[0].toLowerCase().includes('container')) start = 1;

    let placedCount = 0;

    for (let i = start; i < lines.length; i++) {
      const cols = lines[i].split('\t');
      if (cols.length < 4) continue;

      const [containerNum = '', voyage = '', dischargePort = '', locationRaw = '', group = ''] = cols.map(s => s.trim());

      // Super flexible regex: matches "Y11A1", "Y 11A 1", "Y_11A 1", "Y-11-A 2", with spaces around
      const locMatch = locationRaw.match(/Y\s*[_-]?\s*(\d+)\s*([A-Ga-g])\s*(\d+)/i);
      if (!locMatch) {
        console.warn(`Invalid location: "${locationRaw}"`);
        continue;
      }

      const rawNum = parseInt(locMatch[1]);
      const letter = locMatch[2].toUpperCase();
      const stackHeight = parseInt(locMatch[3]) || 1;

      if (rawNum < 9 || rawNum > 39 || rawNum % 2 !== 1) {
        console.warn(`Skipped even/invalid column: ${rawNum} (only odd bays 9,11,...,39 allowed)`);
        continue;
      }

      const index = (rawNum - 9) / 2;
      const letIdx = 'ABCDEFG'.indexOf(letter);

      if (index < 0 || index >= numOddCols || letIdx === -1 || stackHeight < 1) {
        console.warn(`Out of bounds: col=${rawNum}, row=${letter}`);
        continue;
      }

      const x = -gridSizeX / 2 + (index + 0.5) * cellWidth;
      const z = -gridSizeZ / 2 + (letIdx + 0.5) * cellDepth;
      const key = `${index}-${letIdx}`;

      let contLength = 20;
      const groupLower = group.toLowerCase();
      if (groupLower.includes('40') || groupLower === '40') contLength = 40;

      const contWidth = 10;
      const contHeight = 8.5;
      const yBase = (stackHeight - 1) * contHeight;

      const contGeo = new THREE.BoxGeometry(contLength, contHeight, contWidth);
      const colorHash = group ? group.split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 0xffffff : 0xaaaaaa;
      const contMat = new THREE.MeshStandardMaterial({ color: colorHash });
      const contMesh = new THREE.Mesh(contGeo, contMat);
      contMesh.position.set(x, yBase + contHeight / 2, z);
      scene.add(contMesh);

      loader.load('https://cdn.jsdelivr.net/npm/three@0.170.0/examples/fonts/helvetiker_regular.typeface.json', font => {
        const labelGeo = new TextGeometry(`${containerNum} (${group || '20'})`, { font, size: 2.5, depth: 0.3 });
        const label = new THREE.Mesh(labelGeo, new THREE.MeshBasicMaterial({ color: 0x000000 }));
        label.position.set(x - contLength / 2 + 2, yBase + contHeight + 1.5, z + contWidth / 2 - 1);
        label.rotation.y = Math.PI / 2;
        scene.add(label);
      });

      const stack = containers.get(key) || [];
      stack.push(contMesh);
      containers.set(key, stack);

      placedCount++;
    }

    console.log(`Placed ${placedCount} containers successfully`);

    pasteModal.style.display = 'none';
    pasteTextarea.value = '';
  });

  // ─── Animate ───────────────────────────────────────────────────
  function animate() {
    requestAnimationFrame(animate);

    if (controls.isLocked) {
      const time = performance.now();
      const delta = (time - prevTime) / 1000;

      velocity.x -= velocity.x * 8.0 * delta;
      velocity.y -= velocity.y * 8.0 * delta;
      velocity.z -= velocity.z * 8.0 * delta;

      direction.z = Number(move.forward) - Number(move.backward);
      direction.x = Number(move.right)   - Number(move.left);
      direction.y = Number(move.up)      - Number(move.down);
      direction.normalize();

      const speed = 160.0;

      if (move.forward || move.backward) velocity.z -= direction.z * speed * delta;
      if (move.left    || move.right)    velocity.x -= direction.x * speed * delta;
      if (move.up      || move.down)     velocity.y += direction.y * speed * delta;

      controls.moveRight(-velocity.x * delta);
      controls.getObject().position.y += velocity.y * delta;
      controls.moveForward(-velocity.z * delta);

      prevTime = time;
    }

    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
</script>
</body>
</html>
